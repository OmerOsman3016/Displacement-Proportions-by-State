<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .frame-container {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    .map-container {
      width: 100%;
      height: 100%;
    }
    .pie-map {
      width: 100%;
      height: 100%;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      line-height: 1.5;
      font-size: 14px;
    }
    .legend h4 {
      margin: 0 0 10px;
      text-align: center;
    }
    .legend-checkbox {
      margin: 5px 0;
    }
    .marker-size-controls {
      margin-top: 10px;
    }
    .marker-size-label {
      font-size: 12px;
      color: #555;
      margin: 5px 0;
    }
    .marker-size-buttons button {
      padding: 3px 8px;
      margin-right: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    .marker-size-buttons button.active {
      background: #418FDE;
      color: white;
      border: 1px solid #418FDE;
    }
    .pie-tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      pointer-events: none;
      z-index: 1000;
      font-size: 12px;
      max-width: 200px;
      transition: opacity 0.3s;
      opacity: 0;
    }
    .pie-chart-marker {
      transition: transform 0.3s ease;
    }
    .pie-chart-marker:hover {
      transform: scale(1.2);
      z-index: 1000 !important;
    }
  </style>
</head>
<body>
<div class="frame-container">
  <div class="map-container">
    <div id="map5" class="pie-map"></div>
    <div id="pie-tooltip" class="pie-tooltip"></div>
  </div>
</div>

<!-- External JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
<script>
// Define Mapbox custom layers
const mapboxCustom1 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

const mapboxCustom2 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

const mapboxCustom3 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

const mapboxCustom4 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

// Define other base layers
const cartoDBLight1 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});

const openStreetMap1 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});

const esriWorldImagery1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
});

const stamenToner1 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
  attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
});

const mapboxLight = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

const mapboxStreets = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

const mapboxSatellite = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

const mapboxOutdoors = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    tileSize: 512,
    zoomOffset: -1,
    maxZoom: 18
});

// Pie Chart Map Showing Displacement Proportions with Animation
const map5 = L.map('map5').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

// Add default base layer
mapboxCustom1.addTo(map5);

// Add layer control
const baseLayers = {
  "Mapbox Custom 1": mapboxCustom1,
  "Mapbox Custom 2": mapboxCustom2,
  "Mapbox Custom 3": mapboxCustom3,
  "Mapbox Custom 4": mapboxCustom4,
  "CartoDB Light": cartoDBLight1,
  "OpenStreetMap": openStreetMap1,
  "Esri World Imagery": esriWorldImagery1,
  "Stamen Toner": stamenToner1,
  "Mapbox Light": mapboxLight,
  "Mapbox Streets": mapboxStreets,
  "Mapbox Outdoors": mapboxOutdoors,
  "Mapbox Satellite": mapboxSatellite
};

L.control.layers(baseLayers).addTo(map5);

// State data with coordinates (lat, lng), displaced, total population
const stateData = [
  ["Aj Jazirah", 14.900, 33.434, 876156, 5687557],
  ["Blue Nile", 11.270, 34.390, 270810, 1344267],
  ["Central Darfur", 12.900, 23.470, 749491, 1786503],
  ["East Darfur", 11.160, 26.140, 247874, 1213951],
  ["Gedaref", 14.040, 35.380, 14327, 2545604],
  ["Kassala", 15.450, 36.400, 6211, 2811446],
  ["Khartoum", 15.501, 32.560, 3500400, 9146191],
  ["North Darfur", 15.766, 27.333, 1844175, 2775652],
  ["North Kordofan", 13.630, 27.930, 91161, 2160476],
  ["Northern", 19.615, 30.416, 12052, 1023194],
  ["Red Sea", 19.580, 37.130, 30480, 1549857],
  ["River Nile", 18.500, 33.800, 53683, 1651873],
  ["Sennar", 13.550, 33.600, 244250, 2170863],
  ["South Darfur", 11.783, 24.883, 2082537, 3912372],
  ["South Kordofan", 11.150, 29.633, 414734, 2017962],
  ["West Darfur", 12.900, 22.466, 368971, 1940860],
  ["West Kordofan", 11.200, 28.433, 314484, 1713462],
  ["White Nile", 13.450, 32.500, 179544, 3046811]
];

// Create pie chart icon function with animation support
function createPieChartIcon(displaced, total, sizeFactor = 1, animateProgress = 1) {
  const displacedPercent = displaced / total;
  const endAngle = displacedPercent * 360 * animateProgress;
  
  const baseRadius = 30;
  const radius = baseRadius * sizeFactor;
  
  const svg = `
    <svg width="${radius * 2}" height="${radius * 2}" viewBox="0 0 ${radius * 2} ${radius * 2}">
      <circle cx="${radius}" cy="${radius}" r="${radius}" fill="#418FDE"/>
      <path d="M${radius},${radius} L${radius},0 A${radius},${radius} 0 ${endAngle > 180 ? 1 : 0},1 
        ${radius + Math.sin((endAngle * Math.PI)/180) * radius},
        ${radius - Math.cos((endAngle * Math.PI)/180) * radius} z" 
        fill="rgba(255, 103, 31, 0.8)"/>
      <circle cx="${radius}" cy="${radius}" r="${radius * 0.6}" fill="white" opacity="0.7"/>
      <text x="${radius}" y="${radius}" text-anchor="middle" dominant-baseline="middle" 
            font-size="${8 * sizeFactor}" font-weight="bold" fill="#e04c4c">
        ${Math.round(displacedPercent * 100 * animateProgress)}%
      </text>
    </svg>
  `;

  return L.divIcon({
    html: svg,
    iconSize: [radius * 2, radius * 2],
    className: 'pie-chart-marker'
  });
}

// Tooltip element
const tooltip = document.getElementById('pie-tooltip');

// Create a layer group for the pie chart markers
const pieMarkersLayer = L.layerGroup().addTo(map5);
    
// Store references to all pie chart markers
const pieMarkers = [];

// Add markers with animated pie charts
stateData.forEach((state, index) => {
  const [name, lat, lng, displaced, total] = state;
  
  // Start with empty pie (progress = 0)
  const marker = L.marker([lat, lng], {
    icon: createPieChartIcon(displaced, total, 1.0, 0)
  }).addTo(pieMarkersLayer);
  
  // Store reference to marker
  const pieMarker = {
    name: name,
    lat: lat,
    lng: lng,
    displaced: displaced,
    total: total,
    marker: marker
  };
  
  pieMarkers.push(pieMarker);
  
  // Animate this marker
  const start = { progress: 0 };
  const end = { progress: 1 };
  
  new TWEEN.Tween(start)
    .to(end, 1000)
    .delay(index * 100)
    .easing(TWEEN.Easing.Elastic.Out)
    .onUpdate(() => {
      marker.setIcon(
        createPieChartIcon(
          displaced, 
          total, 
          1.0, 
          start.progress
        )
      );
    })
    .start();
  
  // Add hover interactions
  marker.on('mouseover', function(e) {
    // Highlight this marker
    marker.setIcon(createPieChartIcon(displaced, total, 1.3));
    
    // Show tooltip
    tooltip.innerHTML = `
      <b>${name}</b><br>
      Total Population: ${total.toLocaleString()}<br>
      Displaced: ${displaced.toLocaleString()} (${((displaced/total)*100).toFixed(1)}%)<br>
      Non-Displaced: ${(total - displaced).toLocaleString()}
    `;
    tooltip.style.opacity = '1';
    tooltip.style.left = `${e.originalEvent.pageX + 10}px`;
    tooltip.style.top = `${e.originalEvent.pageY + 10}px`;
  });
  
  marker.on('mouseout', function() {
    // Return to normal size
    marker.setIcon(createPieChartIcon(displaced, total, 1.0));
    tooltip.style.opacity = '0';
  });
  
  marker.on('mousemove', function(e) {
    tooltip.style.left = `${e.originalEvent.pageX + 10}px`;
    tooltip.style.top = `${e.originalEvent.pageY + 10}px`;
  });
});

// Start animation loop
function animate() {
  requestAnimationFrame(animate);
  TWEEN.update();
}
animate();

// Enhanced legend control for pie chart map
const legend5 = L.control({ position: 'bottomright' });
legend5.onAdd = () => {
  const div = L.DomUtil.create('div', 'legend');
  div.innerHTML = `
    <h4>Displacement Proportion</h4>
    <div class="legend-checkbox">
      <input type="checkbox" id="displaced-checkbox" checked>
      <label for="displaced-checkbox">Displaced Population</label>
    </div>
    <div class="legend-checkbox">
      <input type="checkbox" id="remaining-checkbox" checked>
      <label for="remaining-checkbox">Remaining Population</label>
    </div>
    <div class="marker-size-controls">
      <div class="marker-size-label">Hover over markers for details</div>
      <div class="marker-size-label">Marker size represents total population</div>
    </div>
  `;
  
  // Add functionality to checkboxes
  const displacedCheckbox = div.querySelector('#displaced-checkbox');
  const remainingCheckbox = div.querySelector('#remaining-checkbox');
  
  displacedCheckbox.addEventListener('change', function() {
    // Toggle visibility of displaced segments (orange)
    const opacity = this.checked ? 0.8 : 0;
    pieMarkers.forEach(pieMarker => {
      const icon = pieMarker.marker.getIcon();
      const newHtml = icon.options.html.replace(/fill="rgba\(255, 103, 31, [\d.]+\)"/g, 
                                      `fill="rgba(255, 103, 31, ${opacity})"`);
      icon.options.html = newHtml;
      pieMarker.marker.setIcon(icon);
    });
  });
  
  remainingCheckbox.addEventListener('change', function() {
    // Toggle visibility of remaining segments (blue)
    const opacity = this.checked ? 1 : 0;
    pieMarkers.forEach(pieMarker => {
      const icon = pieMarker.marker.getIcon();
      const newHtml = icon.options.html.replace(/fill="#418FDE"/g, 
                                      `fill="rgba(65, 143, 222, ${opacity})"`);
      icon.options.html = newHtml;
      pieMarker.marker.setIcon(icon);
    });
  });
  
  return div;
};
legend5.addTo(map5);

// Update tooltip position on map move
map5.on('mousemove', function(e) {
  tooltip.style.left = `${e.originalEvent.pageX + 10}px`;
  tooltip.style.top = `${e.originalEvent.pageY + 10}px`;
});
</script>
</body>
</html>
