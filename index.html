<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .frame-container {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .map-container {
      flex: 1;
      position: relative;
    }
    .pie-map {
      width: 100%;
      height: 100%;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      line-height: 1.5;
      font-size: 14px;
    }
    .legend h4 {
      margin: 0 0 10px;
      text-align: center;
    }
    .legend-checkbox {
      margin: 5px 0;
    }
    .marker-size-controls {
      margin-top: 10px;
    }
    .marker-size-label {
      font-size: 12px;
      color: #555;
      margin: 5px 0;
    }
    .marker-size-buttons {
      display: flex;
      gap: 5px;
      margin: 5px 0;
    }
    .marker-size-buttons button {
      flex: 1;
      padding: 3px 5px;
      font-size: 12px;
      cursor: pointer;
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .marker-size-buttons button.active {
      background: #418FDE;
      color: white;
      border-color: #2a7bc8;
    }
    .pie-chart-marker {
      transition: all 0.3s ease;
    }
    .pie-chart-marker:hover {
      transform: scale(1.1);
      z-index: 1000;
    }
    .pie-tooltip {
      position: absolute;
      background: white;
      padding: 5px 10px;
      border-radius: 3px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      pointer-events: none;
      font-size: 12px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s;
    }
  </style>
</head>
<body>
  <div class="frame-container">
    <div class="map-container">
      <div id="map5" class="pie-map"></div>
    </div>
  </div>

  <!-- Tooltip element -->
  <div id="pie-tooltip" class="pie-tooltip"></div>

  <!-- External JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <script>
    // Pie Chart Map Showing Displacement Proportions
    const map5 = L.map('map5').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map5);

    // State data with coordinates (lat, lng), displaced, total population
    const stateData = [
      ["Aj Jazirah", 14.900, 33.434, 876156, 5687557],
      ["Blue Nile", 11.270, 34.390, 270810, 1344267],
      ["Central Darfur", 12.900, 23.470, 749491, 1786503],
      ["East Darfur", 11.160, 26.140, 247874, 1213951],
      ["Gedaref", 14.040, 35.380, 14327, 2545604],
      ["Kassala", 15.450, 36.400, 6211, 2811446],
      ["Khartoum", 15.501, 32.560, 3500400, 9146191],
      ["North Darfur", 15.766, 27.333, 1844175, 2775652],
      ["North Kordofan", 13.630, 27.930, 91161, 2160476],
      ["Northern", 19.615, 30.416, 12052, 1023194],
      ["Red Sea", 19.580, 37.130, 30480, 1549857],
      ["River Nile", 18.500, 33.800, 53683, 1651873],
      ["Sennar", 13.550, 33.600, 244250, 2170863],
      ["South Darfur", 11.783, 24.883, 2082537, 3912372],
      ["South Kordofan", 11.150, 29.633, 414734, 2017962],
      ["West Darfur", 12.900, 22.466, 368971, 1940860],
      ["West Kordofan", 11.200, 28.433, 314484, 1713462],
      ["White Nile", 13.450, 32.500, 179544, 3046811]
    ];

    // Tooltip element
    const tooltip = document.getElementById('pie-tooltip');

    // Create pie chart icon function with interactive elements
    function createPieChartIcon(displaced, total, sizeFactor = 1, name = '') {
      const displacedPercent = displaced / total;
      const endAngle = displacedPercent * 360;
      
      const baseRadius = 30;
      const radius = baseRadius * sizeFactor;
      
      // Create interactive SVG with hoverable segments
      const svg = `
        <svg width="${radius * 2}" height="${radius * 2}" viewBox="0 0 ${radius * 2} ${radius * 2}">
          <!-- Non-displaced segment (blue) with hover effect -->
          <circle cx="${radius}" cy="${radius}" r="${radius}" fill="#418FDE" 
                  class="pie-segment remaining" 
                  data-name="${name}" data-value="${total - displaced}" data-type="remaining"
                  style="cursor: pointer;"/>
          
          <!-- Displaced segment (orange) with hover effect -->
          <path d="M${radius},${radius} L${radius},0 A${radius},${radius} 0 ${endAngle > 180 ? 1 : 0},1 
            ${radius + Math.sin((endAngle * Math.PI)/180) * radius},
            ${radius - Math.cos((endAngle * Math.PI)/180) * radius} z" 
            fill="rgba(255, 103, 31, 0.8)" 
            class="pie-segment displaced" 
            data-name="${name}" data-value="${displaced}" data-type="displaced"
            style="cursor: pointer;"/>
          
          <!-- Center circle with percentage -->
          <circle cx="${radius}" cy="${radius}" r="${radius * 0.6}" fill="white" opacity="0.7"/>
          <text x="${radius}" y="${radius}" text-anchor="middle" dominant-baseline="middle" 
                font-size="${8 * sizeFactor}" font-weight="bold" fill="#e04c4c">
            ${Math.round(displacedPercent * 100)}%
          </text>
        </svg>
      `;

      return L.divIcon({
        html: svg,
        iconSize: [radius * 2, radius * 2],
        className: 'pie-chart-marker'
      });
    }

    // Create a layer group for the pie chart markers
    const pieMarkersLayer = L.layerGroup().addTo(map5);
        
    // Store references to all pie chart markers
    const pieMarkers = [];

    // Add markers with interactive pie charts
    stateData.forEach(state => {
      const [name, lat, lng, displaced, total] = state;
      
      const marker = L.marker([lat, lng], {
        icon: createPieChartIcon(displaced, total, 1.0, name)
      }).addTo(pieMarkersLayer).bindPopup(`
        <b>${name}</b><br>
        Total Population: ${total.toLocaleString()}<br>
        Displaced: ${displaced.toLocaleString()} (${((displaced/total)*100).toFixed(1)}%)<br>
        Non-Displaced: ${(total - displaced).toLocaleString()}
      `);
      
      // Store reference to marker
      pieMarkers.push({
        name: name,
        lat: lat,
        lng: lng,
        displaced: displaced,
        total: total,
        marker: marker
      });
    });

    // Add hover effects to pie chart segments
    document.addEventListener('DOMContentLoaded', function() {
      // This will run after all markers are added to the DOM
      setTimeout(() => {
        const segments = document.querySelectorAll('.pie-segment');
        
        segments.forEach(segment => {
          // Mouse enter event
          segment.addEventListener('mouseenter', function(e) {
            const type = this.getAttribute('data-type');
            const name = this.getAttribute('data-name');
            const value = parseInt(this.getAttribute('data-value'));
            const percent = type === 'displaced' 
              ? ((value / pieMarkers.find(m => m.name === name).total * 100).toFixed(1) + '%' 
              : '';
            
            // Highlight the segment
            if (type === 'displaced') {
              this.setAttribute('fill', 'rgba(255, 70, 0, 1)');
            } else {
              this.setAttribute('fill', '#2a7bc8');
            }
            
            // Show tooltip
            tooltip.innerHTML = `<b>${name}</b><br>${type === 'displaced' ? 'Displaced' : 'Non-Displaced'}: ${value.toLocaleString()} ${percent}`;
            tooltip.style.opacity = '1';
            
            // Position tooltip near cursor
            const rect = this.getBoundingClientRect();
            tooltip.style.left = `${rect.right + 5}px`;
            tooltip.style.top = `${rect.top}px`;
          });
          
          // Mouse leave event
          segment.addEventListener('mouseleave', function() {
            const type = this.getAttribute('data-type');
            
            // Restore original color
            if (type === 'displaced') {
              this.setAttribute('fill', 'rgba(255, 103, 31, 0.8)');
            } else {
              this.setAttribute('fill', '#418FDE');
            }
            
            // Hide tooltip
            tooltip.style.opacity = '0';
          });
          
          // Click event
          segment.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent map click events
            const name = this.getAttribute('data-name');
            const marker = pieMarkers.find(m => m.name === name);
            if (marker) {
              marker.marker.openPopup();
            }
          });
        });
      }, 500); // Small delay to ensure markers are rendered
    });

    // Function to update pie chart sizes
    function updatePieChartSizes(size) {
      const sizeFactors = {
        small: 0.7,
        medium: 1.0,
        large: 1.3
      };
      
      const factor = sizeFactors[size];
      
      // Update all pie chart markers
      pieMarkers.forEach(pieMarker => {
        pieMarker.marker.setIcon(createPieChartIcon(pieMarker.displaced, pieMarker.total, factor, pieMarker.name));
      });
      
      // Reattach event listeners after resize
      setTimeout(() => {
        const segments = document.querySelectorAll('.pie-segment');
        segments.forEach(segment => {
          segment.addEventListener('mouseenter', function(e) {
            const type = this.getAttribute('data-type');
            const name = this.getAttribute('data-name');
            const value = parseInt(this.getAttribute('data-value'));
            const percent = type === 'displaced' 
              ? ((value / pieMarkers.find(m => m.name === name).total * 100).toFixed(1) + '%' 
              : '';
            
            if (type === 'displaced') {
              this.setAttribute('fill', 'rgba(255, 70, 0, 1)');
            } else {
              this.setAttribute('fill', '#2a7bc8');
            }
            
            tooltip.innerHTML = `<b>${name}</b><br>${type === 'displaced' ? 'Displaced' : 'Non-Displaced'}: ${value.toLocaleString()} ${percent}`;
            tooltip.style.opacity = '1';
            
            const rect = this.getBoundingClientRect();
            tooltip.style.left = `${rect.right + 5}px`;
            tooltip.style.top = `${rect.top}px`;
          });
          
          segment.addEventListener('mouseleave', function() {
            const type = this.getAttribute('data-type');
            if (type === 'displaced') {
              this.setAttribute('fill', 'rgba(255, 103, 31, 0.8)');
            } else {
              this.setAttribute('fill', '#418FDE');
            }
            tooltip.style.opacity = '0';
          });
        });
      }, 100);
    }

    // Enhanced legend control for pie chart map
    const legend5 = L.control({ position: 'bottomright' });
    legend5.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Displacement Proportion</h4>
        <div class="legend-checkbox">
          <input type="checkbox" id="displaced-checkbox" checked>
          <label for="displaced-checkbox">Displaced Population</label>
        </div>
        <div class="legend-checkbox">
          <input type="checkbox" id="remaining-checkbox" checked>
          <label for="remaining-checkbox">Remaining Population</label>
        </div>
        <div class="marker-size-controls">
          <div class="marker-size-label">Marker Size</div>
          <div class="marker-size-buttons">
            <button id="size-small">Small</button>
            <button id="size-medium" class="active">Medium</button>
            <button id="size-large">Large</button>
          </div>
          <div class="marker-size-label">Represents total state population</div>
        </div>
      `;
      
      // Add functionality to checkboxes
      const displacedCheckbox = div.querySelector('#displaced-checkbox');
      const remainingCheckbox = div.querySelector('#remaining-checkbox');
      
      displacedCheckbox.addEventListener('change', function() {
        // Toggle visibility of displaced segments (orange)
        const opacity = this.checked ? '0.8' : '0';
        document.querySelectorAll('.pie-segment.displaced').forEach(segment => {
          segment.setAttribute('fill', `rgba(255, 103, 31, ${opacity})`);
        });
      });
      
      remainingCheckbox.addEventListener('change', function() {
        // Toggle visibility of remaining segments (blue)
        const opacity = this.checked ? '1' : '0';
        document.querySelectorAll('.pie-segment.remaining').forEach(segment => {
          segment.setAttribute('fill', `rgba(65, 143, 222, ${opacity})`);
        });
      });
      
      // Add functionality to size buttons
      const sizeButtons = div.querySelectorAll('.marker-size-buttons button');
      sizeButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all buttons
          sizeButtons.forEach(btn => btn.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          
          // Change marker size
          const size = this.id.split('-')[1]; // small, medium, or large
          updatePieChartSizes(size);
        });
      });
      
      return div;
    };
    legend5.addTo(map5);
  </script>
</body>
</html>
