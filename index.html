<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Remove duplicate Chart.js -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./css/styles.css">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 
</head>
<!-- Displacement Section -->
<div class="frame-container">
  <div class="text-container">
    <h2>Displacement Proportions by State</h2>
    <p>
      This map visualizes the proportion of each state's population that has been displaced by the ongoing conflict. The pie chart markers show at a glance which states have been most severely affected, with the orange segments representing displaced populations and blue segments showing remaining residents.
    </p>
    <p>
      <strong>Key insights from the map visualization:</strong>
      <ul>
        <li><strong>North Darfur stands out</strong> with the highest displacement proportion (66%) - nearly two-thirds of its population has been forced to flee</li>
        <li><strong>South Darfur shows</strong> the largest absolute numbers (over 2 million displaced) despite being a smaller proportion (53%) of its larger population</li>
        <li><strong>Khartoum's displacement</strong> (3.5 million people) represents 38% of the state's population, visible through the relative sizes of the pie segments</li>
        <li><strong>Northern states</strong> like Northern and Red Sea show much smaller displacement proportions (1-2%), visible through their predominantly blue pie charts</li>
      </ul>
    </p>
    <p>
      <strong>How to interpret the map symbols:</strong>
      <ul>
        <li>Each pie chart is scaled to the state's total population size</li>
        <li>Orange segments show displaced populations</li>
        <li>Blue segments show non-displaced populations</li>
        <li>The percentage label in each pie shows the exact displacement proportion</li>
        <li>Larger pies indicate states with bigger total populations</li>
      </ul>
    </p>
    <p>
      The spatial distribution reveals clear patterns - states in Darfur and Khartoum show the most severe displacement, while northern and eastern states have been less affected. This visualization helps humanitarian actors quickly identify where needs are greatest and how displacement is impacting different regions proportionally.
    </p>
    <p>
      <strong>Map interaction tips:</strong>
      <ul>
        <li>Click on any pie chart to see detailed state statistics</li>
        <li>Compare states by both segment size (proportion) and overall pie size (total population)</li>
        <li>Note the concentration of large orange segments in western Sudan</li>
      </ul>
    </p>
  </div>
  <div class="map-container">
    <div id="map5" class="pie-map"></div>
  </div>
</div>
<body>
   
  <script>
    // Pie Chart Map Showing Displacement Proportions
const map5 = L.map('map5').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map5);

// State data with coordinates (lat, lng), displaced, total population
const stateData = [
  ["Aj Jazirah", 14.900, 33.434, 876156, 5687557],
  ["Blue Nile", 11.270, 34.390, 270810, 1344267],
  ["Central Darfur", 12.900, 23.470, 749491, 1786503],
  ["East Darfur", 11.160, 26.140, 247874, 1213951],
  ["Gedaref", 14.040, 35.380, 14327, 2545604],
  ["Kassala", 15.450, 36.400, 6211, 2811446],
  ["Khartoum", 15.501, 32.560, 3500400, 9146191],
  ["North Darfur", 15.766, 27.333, 1844175, 2775652],
  ["North Kordofan", 13.630, 27.930, 91161, 2160476],
  ["Northern", 19.615, 30.416, 12052, 1023194],
  ["Red Sea", 19.580, 37.130, 30480, 1549857],
  ["River Nile", 18.500, 33.800, 53683, 1651873],
  ["Sennar", 13.550, 33.600, 244250, 2170863],
  ["South Darfur", 11.783, 24.883, 2082537, 3912372],
  ["South Kordofan", 11.150, 29.633, 414734, 2017962],
  ["West Darfur", 12.900, 22.466, 368971, 1940860],
  ["West Kordofan", 11.200, 28.433, 314484, 1713462],
  ["White Nile", 13.450, 32.500, 179544, 3046811]
];

// Create pie chart icon function with standardized size
function createPieChartIcon(displaced, total, sizeFactor = 1) {
  const displacedPercent = displaced / total;
  const endAngle = displacedPercent * 360;
  
  // Use a fixed radius for all pie charts (e.g., 16 pixels)
  const baseRadius = 30;
  const radius = baseRadius * sizeFactor;
  
  const svg = `
    <svg width="${radius * 2}" height="${radius * 2}" viewBox="0 0 ${radius * 2} ${radius * 2}">
      <circle cx="${radius}" cy="${radius}" r="${radius}" fill="#418FDE"/>
      <path d="M${radius},${radius} L${radius},0 A${radius},${radius} 0 ${endAngle > 180 ? 1 : 0},1 
        ${radius + Math.sin((endAngle * Math.PI)/180) * radius},
        ${radius - Math.cos((endAngle * Math.PI)/180) * radius} z" 
        fill="rgba(255, 103, 31, 0.8)"/>
      <circle cx="${radius}" cy="${radius}" r="${radius * 0.6}" fill="white" opacity="0.7"/>
      <text x="${radius}" y="${radius}" text-anchor="middle" dominant-baseline="middle" 
            font-size="${8 * sizeFactor}" font-weight="bold" fill="#e04c4c">
        ${Math.round(displacedPercent * 100)}%
      </text>
    </svg>
  `;

  return L.divIcon({
    html: svg,
    iconSize: [radius * 2, radius * 2],
    className: 'pie-chart-marker'
  });
}

// Create a layer group for the pie chart markers
const pieMarkersLayer = L.layerGroup().addTo(map5);
    
// Store references to all pie chart markers
const pieMarkers = [];

// Add markers with standardized pie charts
stateData.forEach(state => {
  const [name, lat, lng, displaced, total] = state;
  
  const marker = L.marker([lat, lng], {
    icon: createPieChartIcon(displaced, total, 1.0) // Default medium size
  }).addTo(pieMarkersLayer).bindPopup(`
    <b>${name}</b><br>
    Total Population: ${total.toLocaleString()}<br>
    Displaced: ${displaced.toLocaleString()} (${((displaced/total)*100).toFixed(1)}%)<br>
    Non-Displaced: ${(total - displaced).toLocaleString()}
  `);
  
  // Store reference to marker
  pieMarkers.push({
    name: name,
    lat: lat,
    lng: lng,
    displaced: displaced,
    total: total,
    marker: marker
  });
});

// Function to update pie chart sizes
function updatePieChartSizes(size) {
  const sizeFactors = {
    small: 0.7,
    medium: 1.0,
    large: 1.3
  };
  
  const factor = sizeFactors[size];
  
  // Update all pie chart markers
  pieMarkers.forEach(pieMarker => {
    pieMarker.marker.setIcon(createPieChartIcon(pieMarker.displaced, pieMarker.total, factor));
  });
}

// Enhanced legend control for pie chart map
const legend5 = L.control({ position: 'bottomright' });
legend5.onAdd = () => {
  const div = L.DomUtil.create('div', 'legend');
  div.innerHTML = `
    <h4>Displacement Proportion</h4>
    <div class="legend-checkbox">
      <input type="checkbox" id="displaced-checkbox" checked>
      <label for="displaced-checkbox">Displaced Population</label>
    </div>
    <div class="legend-checkbox">
      <input type="checkbox" id="remaining-checkbox" checked>
      <label for="remaining-checkbox">Remaining Population</label>
    </div>
    <div class="marker-size-controls">
      <div class="marker-size-label">Marker Size</div>
      <div class="marker-size-buttons">
        <button id="size-small">Small</button>
        <button id="size-medium" class="active">Medium</button>
        <button id="size-large">Large</button>
      </div>
      <div class="marker-size-label">Represents total state population</div>
    </div>
  `;
  
  // Add functionality to checkboxes
  const displacedCheckbox = div.querySelector('#displaced-checkbox');
  const remainingCheckbox = div.querySelector('#remaining-checkbox');
  
  displacedCheckbox.addEventListener('change', function() {
    // Toggle visibility of displaced segments (orange)
    const opacity = this.checked ? 1 : 0;
    pieMarkers.forEach(pieMarker => {
      const icon = pieMarker.marker.getIcon();
      const newHtml = icon.options.html.replace(/fill="rgba\(255, 103, 31, [\d.]+\)"/g, 
                                      `fill="rgba(255, 103, 31, ${opacity})"`);
      icon.options.html = newHtml;
      pieMarker.marker.setIcon(icon);
    });
  });
  
  remainingCheckbox.addEventListener('change', function() {
    // Toggle visibility of remaining segments (blue)
    const opacity = this.checked ? 1 : 0;
    pieMarkers.forEach(pieMarker => {
      const icon = pieMarker.marker.getIcon();
      const newHtml = icon.options.html.replace(/fill="#418FDE"/g, 
                                      `fill="rgba(65, 143, 222, ${opacity})"`);
      icon.options.html = newHtml;
      pieMarker.marker.setIcon(icon);
    });
  });
  
  // Add functionality to size buttons
  const sizeButtons = div.querySelectorAll('.marker-size-buttons button');
  sizeButtons.forEach(button => {
    button.addEventListener('click', function() {
      // Remove active class from all buttons
      sizeButtons.forEach(btn => btn.classList.remove('active'));
      // Add active class to clicked button
      this.classList.add('active');
      
      // Change marker size
      const size = this.id.split('-')[1]; // small, medium, or large
      updatePieChartSizes(size);
    });
  });
  
  return div;
};
legend5.addTo(map5);
  </script>
</body>
</html>
 
