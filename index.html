<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Remove duplicate Chart.js -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./css/styles.css">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 
</head>
<!-- Displacement Section -->
<div class="frame-container">
  <div class="map-container">
    <div id="map5" class="pie-map"></div>
  </div>
</div>
<body>
   
  <script>
    // Pie Chart Map Showing Displacement Proportions
const map5 = L.map('map5').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map5);

// State data with coordinates (lat, lng), displaced, total population
const stateData = [
  ["Aj Jazirah", 14.900, 33.434, 876156, 5687557],
  ["Blue Nile", 11.270, 34.390, 270810, 1344267],
  ["Central Darfur", 12.900, 23.470, 749491, 1786503],
  ["East Darfur", 11.160, 26.140, 247874, 1213951],
  ["Gedaref", 14.040, 35.380, 14327, 2545604],
  ["Kassala", 15.450, 36.400, 6211, 2811446],
  ["Khartoum", 15.501, 32.560, 3500400, 9146191],
  ["North Darfur", 15.766, 27.333, 1844175, 2775652],
  ["North Kordofan", 13.630, 27.930, 91161, 2160476],
  ["Northern", 19.615, 30.416, 12052, 1023194],
  ["Red Sea", 19.580, 37.130, 30480, 1549857],
  ["River Nile", 18.500, 33.800, 53683, 1651873],
  ["Sennar", 13.550, 33.600, 244250, 2170863],
  ["South Darfur", 11.783, 24.883, 2082537, 3912372],
  ["South Kordofan", 11.150, 29.633, 414734, 2017962],
  ["West Darfur", 12.900, 22.466, 368971, 1940860],
  ["West Kordofan", 11.200, 28.433, 314484, 1713462],
  ["White Nile", 13.450, 32.500, 179544, 3046811]
];

function createPieChartIcon(displaced, total, sizeFactor = 1) {
  const displacedPercent = displaced / total;
  const angle = displacedPercent * 360;
  
  const baseRadius = 30;
  const radius = baseRadius * sizeFactor;
  
  const endX = radius + Math.sin((angle * Math.PI)/180) * radius;
  const endY = radius - Math.cos((angle * Math.PI)/180) * radius;
  const largeArc = angle > 180 ? 1 : 0;

  const displacedColor = 'rgba(255, 103, 31, 0.8)';
  const remainingColor = '#418FDE';

  const svg = `
    <svg width="${radius * 2}" height="${radius * 2}" viewBox="0 0 ${radius * 2} ${radius * 2}" xmlns="http://www.w3.org/2000/svg">
      <path d="M${radius},${radius} L${radius},0 
        A${radius},${radius} 0 ${largeArc},1 ${endX},${endY} Z" 
        fill="${displacedColor}"
        onmouseover="this.setAttribute('fill', '#ff471a');"
        onmouseout="this.setAttribute('fill', '${displacedColor}');"
        onclick="alert('${Math.round(displacedPercent * 100)}% Displaced');"/>
      <path d="M${endX},${endY} 
        A${radius},${radius} 0 ${1 - largeArc},1 ${radius},0 
        L${radius},${radius} Z" 
        fill="${remainingColor}"
        onmouseover="this.setAttribute('fill', '#66b3ff');"
        onmouseout="this.setAttribute('fill', '${remainingColor}');"
        onclick="alert('${Math.round((1 - displacedPercent) * 100)}% Remaining');"/>
      <circle cx="${radius}" cy="${radius}" r="${radius * 0.6}" fill="white" opacity="0.7"/>
      <text x="${radius}" y="${radius}" text-anchor="middle" dominant-baseline="middle" 
            font-size="${8 * sizeFactor}" font-weight="bold" fill="#e04c4c">
        ${Math.round(displacedPercent * 100)}%
      </text>
    </svg>
  `;

  return L.divIcon({
    html: svg,
    iconSize: [radius * 2, radius * 2],
    className: 'pie-chart-marker'
  });
}

legend5.addTo(map5);
  </script>
</body>
</html>
